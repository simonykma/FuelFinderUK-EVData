name: Sync UK EV Data from OCM Export

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours (00:00, 06:00, 12:00, 18:00 UTC)
  workflow_dispatch:

permissions:
  contents: write
  pages: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout our repo
        uses: actions/checkout@v4

      - name: Download GB data from OCM Export
        run: |
          # Download just the GB folder using GitHub's archive feature
          curl -L "https://github.com/openchargemap/ocm-export/archive/refs/heads/main.zip" -o ocm.zip
          unzip -q ocm.zip "ocm-export-main/data/GB/*" || true
          mv ocm-export-main/data/GB ./GB-data || mkdir -p ./GB-data
          rm -rf ocm.zip ocm-export-main
          
          echo "Downloaded $(ls ./GB-data/*.json 2>/dev/null | wc -l) UK stations"

      - name: Combine UK stations into single file
        run: |
          mkdir -p public
          
          # Use jq if available, otherwise use shell
          if command -v jq &> /dev/null; then
            jq -s '.' ./GB-data/*.json > public/uk-ev-stations.json
          else
            # Combine all UK POI files into one JSON array
            echo "[" > public/uk-ev-stations.json
            first=true
            for file in ./GB-data/*.json; do
              if [ -f "$file" ]; then
                if [ "$first" = true ]; then
                  first=false
                else
                  echo "," >> public/uk-ev-stations.json
                fi
                cat "$file" >> public/uk-ev-stations.json
              fi
            done
            echo "]" >> public/uk-ev-stations.json
          fi
          
          # Get station count
          STATION_COUNT=$(ls ./GB-data/*.json 2>/dev/null | wc -l | tr -d ' ')
          
          # Create metadata
          echo "{\"updated\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"count\":$STATION_COUNT}" > public/metadata.json
          
          echo "âœ… Combined $STATION_COUNT UK EV stations"
          ls -lh public/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
